<!DOCTYPE html>
<!--Splash screen to lead into interface-->
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>AudioLDM2 Fine-Tuning</title>

    <!--Get filesheet from webapp/static/css/style.css-->
    <link rel="stylesheet" href="{{ url_for('static', filename= 'css/style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
</head>
<body>
    {% block content %}
    <div class="container">
        {% for message in get_flashed_messages() %}
        <div class="alert alert-light">
            <button type="button" class="close" data-dismiss="alert" onclick=delete_flash(this)>&times;</button>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endblock %}
    <h1>AudioLDM2 Fine-Tuning and Inference Pipeline</h1>
    <h3>Generate a Sound</h3>
</body>
<script>
    var socket = io();

    // on render of template, set current_state
    let current_state = {{ current_state | tojson }};

    // add event listeners to tab tab buttons
    $('#tabButtonFineTune').click(function() {
        $('.tabSection').hide();
        $('.tabButton').removeClass('active');
        $('.finetuneContainer').show();
        $('#tabButtonFineTune').addClass('active');
        current_state["tab"] = "finetune";
        socket.emit("tab_change", "finetune")
    });
    $('#tabButtonInference').click(function() {
        $('.tabSection').hide();
        $('.tabButton').removeClass('active');
        $('.inferenceContainer').show();
        $('#tabButtonInference').addClass('active');
        current_state["tab"] = "inference";
        socket.emit("tab_change", "inference")
    });
    $('#tabButtonOptions').click(function() {
        $('.tabSection').hide();
        $('.tabButton').removeClass('active');
        $('.optionsContainer').show();
        $('#tabButtonOptions').addClass('active');
        current_state["tab"] = "options";
        socket.emit("tab_change", "options")
    });

    updateCurrentState();

    function updateCurrentState() {
        if (current_state["displayInferenceAudio"]) {
            $('#inferenceAudioContainer').show();
        } else {
            $('#inferenceAudioContainer').hide();
        }
        $('#inferencePrompt').text(current_state["inferencePrompt"]);
        $('#inferenceAudio').attr("src", current_state["inferencePath"]);

        if (Object.keys(current_state["datasets"]).length != 0) {
            $('#importedDatasetForm').parent().show();
            $('#importedDatasetZip').empty();
            current_state["datasets"].forEach(function(dataset) {
                $('#importedDatasetZip').append($('<option>', {
                    value: dataset,
                    text: dataset
                }));
            });
        } else {
            $('#importedDatasetForm').parent().hide();
        }

        if (Object.keys(current_state["checkpoints"]).length != 0) {
            $('#checkpointSelectForm').parent().show();
            $('#checkpointSelect').empty();
            current_state["checkpoints"].forEach(function(checkpoint) {
                $('#checkpointSelect').append($('<option>', {
                    value: checkpoint,
                    text: checkpoint.replace(/^.*[\\/]/, '')
                }));
            });
            $('#inferenceCheckpointSelect').empty();
            current_state["inferenceCheckpoints"].forEach(function(checkpoint) {
                $('#inferenceCheckpointSelect').append($('<option>', {
                    value: checkpoint,
                    text: checkpoint.replace(/^.*[\\/]/, '')
                }));
            });
        } else {
            $('#importedDatasetForm').parent().hide();
        }

        if(current_state["tab"] == "inference") {
            $('.tabSection').hide();
            $('.tabButton').removeClass('active');
            $('.inferenceContainer').show();
            $('#tabButtonInference').addClass('active');
        }
        else if(current_state["tab"] == "options") {
            $('.tabSection').hide();
            $('.tabButton').removeClass('active');
            $('.optionsContainer').show();
            $('#tabButtonOptions').addClass('active');
        }
        else {
            $('.tabSection').hide();
            $('.tabButton').removeClass('active');
            $('.finetuneContainer').show();
            $('#tabButtonFineTune').addClass('active');
        }

        $('#serverStatusVal').text(current_state["monitor"]["torchServerStatus"]);
        $('#epochVal').text(current_state["monitor"]["epoch"]);
        $('#globalStepVal').text(current_state["monitor"]["globalStep"]);
        $('#ddimStepVal').text(current_state["monitor"]["ddimStep"]);
    }
    
    // when received from socket, update current_state
    socket.on("current_state_update", function(data) {
        current_state = data;
        if($('#inferenceAudio').attr("src") != current_state["inferencePath"]){
            // Reload if audio is new, to fetch the new file
            location.href = "/";
        };
        updateCurrentState();
    });

    function debugEmit() {
        //socket.emit("debug");
    }

    $("#parameter").change(function () {
        var selection = this.value;
        var params = current_state["params"];
        $('#paramValue').attr("placeholder", params[selection]);
    });

    function delete_flash(flash){
        $(flash).parent().remove()
    }

    socket.on("monitor", function(data) {
        $('#monitorContent').append(data + "<br>");
    });
</script>